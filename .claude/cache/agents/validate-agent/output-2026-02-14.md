# Plan Validation: Task 8 - Integrate Form, Calculations, and Graph in App.vue
Generated: 2026-02-14

## Overall Status: NEEDS REVIEW

**Summary**: The plan is well-structured and detailed, but validation reveals critical dependency gaps that must be resolved before implementation can proceed. Two essential functions are missing from completed code, and UI components (Tasks 6-7) are not yet implemented.

---

## Prerequisites Status

### Dependency Checklist

| Task | Module | Function | Status | Notes |
|------|--------|----------|--------|-------|
| Task 4 | `multiDose.ts` | `accumulateDoses()` | ✓ IMPLEMENTED | Exports correctly, tested |
| Task 4 | `multiDose.ts` | `getGraphData()` | ❌ MISSING | Not implemented - **BLOCKER** |
| Task 5 | `prescriptionStorage.ts` | `savePrescription()` | ✓ IMPLEMENTED | Exports correctly, tested |
| Task 5 | `prescriptionStorage.ts` | `getAllPrescriptions()` | ✓ IMPLEMENTED | Exports correctly, tested |
| Task 6 | `components/` | `PrescriptionForm.vue` | ❌ MISSING | Component not found - **BLOCKER** |
| Task 7 | `components/` | `GraphViewer.vue` | ❌ MISSING | Component not found - **BLOCKER** |

### Barrel Export Status

| File | Issue | Impact |
|------|-------|--------|
| `src/core/calculations/index.ts` | Missing: `getGraphData` export | HIGH - Plan imports from barrel, will fail |
| `src/core/storage/index.ts` | Complete: All exports present | OK |
| `src/core/models/index.ts` | Complete: All types exported | OK |

---

## Tech Stack Validation

### Vue 3 Composition API Usage
✓ **CORRECT**: Plan uses `<script setup>` with `ref()` and `computed()` correctly
- Reactive state with `ref<Prescription | null>(null)` is the right pattern
- Computed property for `graphDatasets` will recompute reactively on dependencies
- Event handling with `@submit` follows Vue 3 conventions

✓ **CORRECT**: TypeScript typing
- Types imported from models: `import type { Prescription, GraphDataset }`
- Proper use of `ref<T>()` and `computed<T>()`
- Function signatures are fully typed

### Vite & Import Paths
✓ **CORRECT**: Uses `@/` path aliases consistently
- `@/core/models`, `@/core/calculations`, `@/components` - all standard Vite alias patterns
- Fallback note to import directly from module file if barrel not updated is good practice

### Event System
⚠️ **NEEDS VERIFICATION**: PrescriptionForm `@submit` event signature
- Plan assumes: `@submit="handleFormSubmit"` receives `rx: Prescription`
- Depends on Task 6 implementation (not yet built)
- **Risk**: If PrescriptionForm emits `{ prescription: rx }` wrapper object, handler will fail

### localStorage Integration
✓ **CORRECT**: Storage strategy is sound
- `getAllPrescriptions()` wrapped in ref initialization (safe at module scope)
- `savePrescription()` call updates both current and saved refs
- Error handling delegated to Task 5 implementation

---

## Implementation Plan Analysis

### Phase 1: State Management
✓ **WELL-DESIGNED**
- Clear separation: form state, prescription state, timeframe state, display state
- Defaults are sensible: `startHours=0`, `endHours=48` (2 days - shows accumulation)
- `graphDatasets` computed properly depends on all three reactive inputs
- Guard against null: `if (!currentPrescription.value) return []`

### Phase 2: Form Submission & View Switching
✓ **CORRECT FLOW**
- `handleFormSubmit()` sets prescription and toggles display flags correctly
- `newPrescription()` resets state cleanly
- Conditional rendering with `v-if="showForm"` / `v-if="showGraph"` is appropriate

✓ **GOOD DISCLAIMER PLACEMENT**
- Disclaimer outside conditionals means always visible (per CLAUDE.md requirement)
- Educational warning language matches specification

⚠️ **PROP BINDING ISSUE**
- Plan line 188: "Vue auto-converts between kebab-case and camelCase" - **TRUE**, but:
  - Plan shows `:start-hours="startHours"` which is correct Vue template syntax
  - But GraphViewer component doesn't exist yet - can't verify if props are named correctly

### Phase 3: Save & Slider Controls
✓ **CORRECT IMPLEMENTATION**
- `saveCurrentPrescription()` logic is sound:
  - Calls `savePrescription()` which returns saved copy with ID
  - Refreshes `savedPrescriptions` list for future use
  - Updates `currentPrescription` to the saved version (now has ID)
- Slider `v-model.number="endHours"` ensures number type binding
- Range `min="12" max="168" step="12"` aligns with spec

✓ **CSS STYLING**
- Flexbox layout is clean and responsive
- Color scheme matches accessibility guidelines (yellow warning banner)
- Button styling with hover states is appropriate

⚠️ **MAIN.CSS GRID ISSUE**
- Plan correctly identifies that `src/assets/main.css` has a 2-column grid setup
- Recommends "Option A" (no override needed) which is **risky** - needs testing
- `#app` has direct `<main class="app">` child, so main becomes one grid column - this should work
- **Recommendation**: Test on desktop breakpoint before declaring safe

---

## Critical Issues

### 1. BLOCKER: `getGraphData()` Function Missing

**Problem**: The plan imports `getGraphData()` at line 403:
```typescript
import { getGraphData } from '@/core/calculations'
```

**Current State**:
- `multiDose.ts` exports only `accumulateDoses()`
- `getGraphData()` is not defined anywhere in the codebase
- Barrel `src/core/calculations/index.ts` line 8 exports only `accumulateDoses`

**Impact**: HIGH - Task 8 cannot compile without this function

**Resolution Required**:
Task 4 must implement `getGraphData()`. Per CLAUDE.md, signature should be:
```typescript
export function getGraphData(
  prescriptions: Prescription[],
  startHours: number,
  endHours: number
): GraphDataset[]
```

**Workaround**: For now, Task 8 can be tested with a mock.

---

### 2. BLOCKER: PrescriptionForm.vue Component Missing

**Problem**: Plan imports component at line 408:
```typescript
import PrescriptionForm from '@/components/PrescriptionForm.vue'
```

**Current State**: Component does not exist in codebase

**Impact**: HIGH - Cannot mount or test without component

**Resolution Required**: Task 6 must implement this component

---

### 3. BLOCKER: GraphViewer.vue Component Missing

**Problem**: Plan imports component at line 409:
```typescript
import GraphViewer from '@/components/GraphViewer.vue'
```

**Current State**: Component does not exist in codebase

**Impact**: HIGH - Cannot display graphs without component

**Resolution Required**: Task 7 must implement this component

---

## Dependency Chain Validation

Task 8 depends on a 4-task chain:

```
Task 4 (multiDoseProfile.ts)
  ├─ getGraphData() [MISSING]
  └─ accumulateDoses() [✓ EXISTS]

Task 5 (prescriptionStorage.ts)
  ├─ savePrescription() [✓ EXISTS]
  └─ getAllPrescriptions() [✓ EXISTS]

Task 6 (PrescriptionForm.vue) [MISSING]
  └─ submit event with Prescription [TO BE VERIFIED]

Task 7 (GraphViewer.vue) [MISSING]
  └─ props: datasets, startHours, endHours [TO BE VERIFIED]
```

**Risk Level**: HIGH
- 3 of 4 dependencies have critical gaps
- Cannot begin Task 8 without Tasks 4, 6, 7 completion
- Recommend unblocking these tasks first

---

## Edge Cases & Potential Issues

### 1. Chart.js in Test Environment
⚠️ **Issue**: GraphViewer uses Chart.js which requires canvas element
- jsdom (default Vitest environment) has limited canvas support
- Chart.js mock may fail with real canvas operations

**Plan's approach**: Mock entire GraphViewer component in tests ✓ CORRECT

### 2. Slider Debouncing
⚠️ **Issue**: Plan notes (line 756) that slider changes trigger `graphDatasets` recomputation
- At 168h range, 15-min intervals = 672 points per prescription
- For single prescription: likely fast enough
- For multiple prescriptions: may cause UI lag

**Plan Status**: Identified but deferred to future optimization ✓ ACCEPTABLE for MVP

### 3. localStorage Corruption Recovery
✓ **HANDLED**: Task 5 wraps `JSON.parse()` in try/catch, returns `[]` on error
- Plan correctly relies on this graceful fallback
- No additional error handling needed in App.vue

### 4. Null Prescription Handling
✓ **CORRECT**: Multiple guards prevent errors:
- Line 423: `if (!currentPrescription.value) return []` in computed
- Line 439: `if (currentPrescription.value)` before saving

### 5. startHours Unused in Slider
⚠️ **Issue**: Plan defines `startHours` ref (line 418) but never exposes it to user
- Slider only controls `endHours`
- `startHours` is always 0
- This is consistent with spec (simulation always starts at first dose)

**Assessment**: By design, not a bug ✓ CORRECT per spec

---

## Code Quality Assessment

### Naming & Clarity
✓ GOOD
- Clear separation: `currentPrescription`, `savedPrescriptions`, `showForm`, `showGraph`
- Handler names are descriptive: `handleFormSubmit`, `newPrescription`, `saveCurrentPrescription`
- Comments in Phase 3 CSS explain layout strategy

### TypeScript Strictness
✓ GOOD
- Full type annotations throughout
- Proper use of `type` imports for types-only
- No `any` types in the plan

### Component Size & Complexity
✓ ACCEPTABLE
- ~170 lines of code is reasonable for central integration component
- Well-divided into logical sections (state, timeframe, computed, handlers, template, styles)
- Subtask breakdown (8.1, 8.2, 8.3) aids implementation in phases

---

## Testing Strategy Validation

### Mocking Approach
✓ **CORRECT** (lines 628-641):
- Proper use of `vi.mock()` for module mocking
- Mock return values match expected API contracts
- Isolation allows testing App.vue logic independently

⚠️ **ISSUE**: The mock of calculations imports from barrel (`@/core/calculations`), but barrel must export `getGraphData` first

### Test Case Coverage
✓ GOOD (lines 645-655):
- 8 test cases cover happy path, edge cases, and data flow
- Manual browser testing checklist is practical and comprehensive

---

## Documentation & Clarity

✓ **EXCELLENT**
- Plan is extremely detailed (800 lines)
- Three-phase breakdown is clear and implementable
- Complete App.vue reference code provided (lines 399-605)
- Edge case section identifies real risks (lines 741-760)
- Implementation order summary (lines 780-799) is actionable

---

## Summary Table

### Validated (Safe to Proceed):
- ✓ Vue 3 Composition API usage
- ✓ TypeScript typing and strictness
- ✓ Storage integration approach
- ✓ State management design
- ✓ Event handling pattern
- ✓ CSS layout strategy
- ✓ Test mocking approach
- ✓ Documentation quality

### Needs Review:
- ⚠️ main.css grid interaction (recommend testing)
- ⚠️ PrescriptionForm event signature (await Task 6)
- ⚠️ GraphViewer prop naming (await Task 7)
- ⚠️ Performance with slider (acceptable for MVP, noted for future)

### Must Fix Before Implementation:
- ❌ `getGraphData()` not exported from `multiDose.ts` (Task 4 incomplete)
- ❌ `PrescriptionForm.vue` not implemented (Task 6 incomplete)
- ❌ `GraphViewer.vue` not implemented (Task 7 incomplete)

---

## Recommendations

### Before Starting Task 8

1. **Complete Task 4**: Implement `getGraphData()` function
   - Update `src/core/calculations/index.ts` to export it

2. **Complete Task 6**: Implement PrescriptionForm.vue
   - Verify emit event name and payload structure

3. **Complete Task 7**: Implement GraphViewer.vue
   - Verify props accept camelCase names (`startHours`, `endHours`)
   - Confirm Chart.js integration works

### During Task 8 Implementation

1. **Follow the three-phase breakdown**
   - Phase 1: State + computed (test independently)
   - Phase 2: Handlers + template (test view switching)
   - Phase 3: Save + slider (test integration with storage)

2. **Test in phases**
   - After Phase 1: `npm run test -- App.spec.ts` (computed tests)
   - After Phase 2: Mount component and test form submission
   - After Phase 3: Test save flow and slider reactivity

3. **Type-check frequently**
   - `npm run type-check` after each phase
   - Verify barrel exports match imports

---

## Final Verdict

**RECOMMENDATION: Proceed with caution - unblock critical dependencies first**

The plan is well-designed, detailed, and technically sound. However, it cannot be executed until three foundational tasks (4, 6, 7) are completed.

**Estimated effort after dependencies**: 1-2 hours implementation + 30 min tests + 20 min manual verification = ~2.5 hours.

